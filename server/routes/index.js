//======================================================================================
//Import required modules ==============================================================
//======================================================================================
let express = require('express');
let router = express.Router();
let passport = require ('passport');
// get gravatar icon from email ========================================================
let gravatar = require('gravatar')

//======================================================================================
// GET home page. ======================================================================
//======================================================================================
router.get('/',(req, res, next) => {
  res.render('index', { title: 'Express from server folder' });
});

//======================================================================================
// GET login page. =====================================================================
//======================================================================================
router.get('/login', (req, res, next) => {
  res.render('login', {title:"Login Page", message: req.flash('loginMessage')});
});

//======================================================================================
// POST login page. ====================================================================
//======================================================================================
router.post('/login', passport.authenticate('local-login',{
//Success go to Profile Page, Fail go to Sign up Page====================================
    successRedirect :'/profile',
    failureRedirect :'/signup',
    failureFlash : true
}));


//======================================================================================
// GET Sign up page. ===================================================================
//======================================================================================
router.get('/signup', (req, res) => {
   res.render('signup', {title:"Signup Page", message: req.flash('signupMessage') });
});

//======================================================================================
// POST Sign up ========================================================================
//======================================================================================
router.post('/signup', passport.authenticate('local-signup', {
// Go to Profile page if success, failure go to sign up page ===========================
    successRedirect : '/profile',
    failureRedirect : '/signup',
    failureFlash: true
}));

//======================================================================================
// GET profile page. ===================================================================
//======================================================================================
router.get('/profile', isLoggedIn, (req, res, next) => {
   res.render('profile', {
       title:"Profile Page",
       user: req.user,
       avatar: gravatar.url(req.user.email,
           {
           s:'100',
           r:'x',
           d:'retro'
           },
       true)
       });
});

//======================================================================================
// Check if user is logged in ==========================================================
//======================================================================================
isLoggedIn = (req, res, next) => {
    if (req.isAuthenticated())
        return next();
    res.redirect('/login');
};

//======================================================================================
// Get Logout Page =====================================================================
//======================================================================================
router.get('/logout', (req, res) => {
    req.logout();
    res.redirect('/');
});

module.exports = router;

